# プロダクト設計書：『Chimyaku（地脈）』 (Final Version)

## 1. 概要

### 1.1. プロダクトコンセプト

人々の強い想い（記憶）がエネルギーとなって流れる「地脈」が存在する世界。プレイヤーは、地脈の流れを読み解き、各地に現れた他者の「記憶の結晶」を探し出す探査士となり、また自らの記憶を地脈に託すオリジネーターとなる。

Flutterの表現力を活かしたリッチなビジュアル・触覚体験と、生成AIによる動的なコンテンツ生成を融合させた、没入型の位置情報エンターテインメント。

### 1.2. ターゲットユーザー

- 日常の中に少しのファンタジーや非日常感を求める人。
- 他者の人生の断片に触れることにエモーションを感じる人。
- 位置情報ゲームや収集要素のあるゲームが好きな人。

### 1.3. コア体験ループ

1. **埋葬 (Bury):** 自分の記憶をテキストで入力し、AIが生成した唯一無二の「結晶」として地脈に託す。
2. **探索 (Explore):** 地図を頼りに、他者の記憶が結晶化しているエリア（エネルギー飽和点）を探す。
3. **共鳴 (Resonate):** 結晶に近づき、視覚・聴覚・触覚でその「鼓動」を感じ取る。
4. **採掘 (Mine):** エリアに到達し、アクションによって結晶を採掘（アンロック）する。
5. **追体験 (Relive):** 採掘した結晶に触れ、封じられていた他者の記憶を読み解き、図鑑に収集する。

---

## 2. 技術スタック（推奨）

- **フロントエンド:** Flutter (iOS / Android)
- **バックエンド:** Firebase (Auth, Firestore, Cloud Storage, Functions)
- **地図表示:** Mapbox GL JS (または Google Maps Platform)
- **生成AI:** Google Gemini API / OpenAI API (テキスト解析＆画像生成プロンプト作成), DALL-E 3 等 (画像生成)
- **演出・アニメーション:** Rive, ShaderMask, HapticFeedback, audioplayers

---

## 3. 画面・機能詳細仕様

### 3.1. トップ画面（地脈探索マップ）

アプリのホーム画面。世界観への没入と探索の起点。

- **地図表示:**
  - ダークモードのファンタジー風地図。
  - 地脈のエネルギー流（青白いパーティクル）が道や地形に沿ってゆっくり流れている。
  - 他者の記憶が集まっている「結晶化エリア」は、ぼんやりと脈打つ光の渦として表現される（正確なピンは立たない）。光の色は、そのエリアの主要な感情タイプ（後述）を反映。
- **UI:**
  - 魔法陣風デザイン。
  - 画面下部：「メニューボタン（埋葬、図鑑画面へ遷移）」。
- **インタラクション（接近演出 - 鼓動フェーズ）:**
  - 結晶化エリアの中心から半径約100m以内に入ると開始。
  - **視覚:** 画面エッジ（周囲）から、そのエリアの色の光が、心臓の鼓動のリズムで脈打ちながら侵食してくる。近づくほど光が強く、画面中央へ広がる。
  - **触覚・聴覚:** 光の脈動に合わせて、端末のバイブレーション（HapticFeedback.heavyImpact推奨）が「ドクン…ドクン…」と鳴動し、共鳴音が鳴る。近づくほど間隔が短く、強くなる。
- **遷移判定:**
  - 半径25m以内に入ると、画面が光に包まれ、自動的に「採掘画面」へ遷移する。

### 3.2. 埋葬画面（記憶の結晶化儀式）

自らの記憶を地脈に託す画面。AIによる生成体験が主軸。

- **入力:**
  - 「地脈に託す記憶」を入力するテキストエリア。
  - 「結晶化（精製開始）」ボタン。
- **AI生成演出（ローディング）:**
  - ボタン押下後、画面中央に光の粒子が凝縮していく魔法的なアニメーションを表示。
  - バックグラウンドでAIがテキストを解析し、「感情タイプ判定（赤:情熱, 青:静寂, 黄:喜び, 緑:癒やし）」と「結晶画像生成」を行う。
- **生成結果確認:**
  - 生成が完了すると、AIが生成したユニークな「結晶の画像」と、判定された「感情タイプ名」が表示される。
- **埋葬アクション:**
  - 「地脈に還す」ボタンを長押しすると、結晶が光の塊となり、地図上の現在地（足元）に吸い込まれていくアニメーションとともに、データがFirebaseに保存される。

### 3.3. 採掘画面（結晶との対峙）

結晶を発見し、手に入れるためのアクション画面。

- **表示:**
  - 地図ではなく、抽象的な空間やAR背景の中央に、発見した巨大な結晶が鎮座している。結晶はAIが生成したユニークな画像。
- **採掘アクション:**
  - プレイヤーが結晶をタップする。
  - タップに合わせて、激しい火花エフェクト、硬質な効果音、強いバイブレーションが発生。結晶にヒビが入る。
- **完了演出:**
  - 複数回タップして耐久値をゼロにすると、結晶が弾け飛び、まばゆい光の中から記憶の断片（光の玉）が現れる派手なアニメーションが再生され、「記憶追体験画面」へ遷移する。

### 3.4. 記憶追体験画面

採掘した記憶を読み解く、静謐な画面。

- **演出:**
  - 背景がぼやけ、静かな環境音やBGMが流れる。
  - 封じられていたテキストが、魔法のインクのようにゆっくりと浮かび上がる。
- **機能:**
  - 記憶を読み終わったら閉じる。この時点で、この結晶はプレイヤーの「図鑑」に登録される。

### 3.5. 結晶図鑑（ジャーナル）画面

これまでに採掘した他者の記憶コレクション。

- **一覧表示:**
  - 採掘済みの結晶がグリッド状に並ぶ。サムネイルにはAI生成された結晶画像が使用される。
- **詳細表示:**
  - サムネイルをタップすると、結晶の大きな画像、記憶テキスト、発見日時、発見場所（地名）が表示される。

---

## 4. データ構造例 (Firestore)

### `crystals` コレクション (埋められた記憶)

- `id` (Document ID)
- `creatorId` (埋めたユーザーのID)
- `memoryText` (記憶のテキスト内容)
- `emotionType` (AI判定した感情: "passion", "silence", "joy", "healing")
- `imageUrl` (AI生成した結晶画像のStorage URL)
- `location` (GeoPoint: 埋められた緯度経度)
- `createdAt` (Timestamp)

### `users/{userId}/discoveredCrystals` サブコレクション (図鑑用)

- `id` (Document ID: crystalsコレクションのIDと共通化すると管理しやすい)
- `discoveredAt` (Timestamp: 発見した日時)
- *(その他のデータはcrystalsコレクションから参照するか、必要な分だけコピーを持つ)*

---

## 5. ハッカソンでの開発優先度 (MVPスコープ)

期限内に価値を届けるための優先順位設定。

1. **【最優先】コア体験の貫通:**
    - 現在地マップ表示＆結晶エリア配置（ダミーデータ可）。
    - 接近時のバイブレーション演出（鼓動）。
    - エリア到達時の採掘アクション（タップ＆破壊演出）。
    - 採掘後のテキスト表示。
2. **【優先】AI導入:**
    - 埋葬画面でのテキスト入力→AIによる画像＆感情タイプ生成フローの実装。
3. **【準優先】ビジュアル強化:**
    - 地図のダークモード化、地脈の発光表現（ShaderMask等）。
    - 採掘時の派手なアニメーション強化（Rive等）。
4. **【余裕があれば】:**
    - 結晶図鑑画面の実装。
    - 音響効果（接近音、環境音）の追加。
